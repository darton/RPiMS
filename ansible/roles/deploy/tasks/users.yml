---
- name: Ensure rpims group exists
  group:
    name: "{{ rpims_user }}"

- name: Ensure rpims user exists
  user:
    name: "{{ rpims_user }}"
    group: "{{ rpims_user }}"
    shell: /bin/bash
    create_home: yes
    system: no

- name: Ensure home directory permissions for rpims
  file:
    path: "/home/{{ rpims_user }}"
    state: directory
    owner: "{{ rpims_user }}"
    group: "{{ rpims_user }}"
    mode: '0755'

- name: Ensure .ansible directory exists for rpims
  file:
    path: "/home/{{ rpims_user }}/.ansible"
    state: directory
    owner: "{{ rpims_user }}"
    group: "{{ rpims_user }}"
    mode: '0700'

- name: Add existing "{{ rpims_user }}" user to groups
  user:
    name: "{{ rpims_user }}"
    groups: 
      - sudo
      - adm
      - video
      - plugdev
      - users
      - input
      - render
      - netdev
      - spi
      - i2c
      - gpio
      - audio
      - cdrom
      - dialout
    append: yes
  become: true

- name: Allow rpims to use sudo without password
  copy:
    dest: /etc/sudoers.d/rpims
    content: "{{ rpims_user }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: '0440'
  become: true

- name: Add existing "{{ zabbix_user }}" user to rpims group
  user:
    name: "{{ zabbix_user }}"
    groups:
      - "{{ rpims_user }}"
    append: yes
  become: true
  tags:
    - zabbix

- name: Allow zabbix to use sudo without password
  copy:
    dest: /etc/sudoers.d/zabbix
    content: "{{ zabbix_user }} ALL=(ALL) NOPASSWD: {{ rpims_install_dir }}/scripts/redis-get-data.py\n"
    owner: root
    group: root
    mode: '0440'
  become: true
  tags:
    - zabbix
